### 多线程破解

话不多说，直接上题（BUUCTF）

![](https://pic1.imgdb.cn/item/67b56914d0e0a243d400aea3.png)

发现有壳

![](https://pic1.imgdb.cn/item/67b569dad0e0a243d400aee1.png)

使用工具脱壳

![](https://pic1.imgdb.cn/item/67b56a04d0e0a243d400aef4.png)

直接进入 main 函数

首先调用了 sub_4110FF()，去看看

![](https://pic1.imgdb.cn/item/67b56c1ed0e0a243d400af9d.png)

又是一个调用

![](https://pic1.imgdb.cn/item/67b56ce8d0e0a243d400b018.png)

接受用户输入的值

![](https://pic1.imgdb.cn/item/67b56cf7d0e0a243d400b021.png)

回到 main 函数，它往下创建了两个线程

```c
hObject = CreateThread(0, 0, StartAddress, 0, 0, 0);
Thread = CreateThread(0, 0, sub_41119F, 0, 0, 0);
CloseHandle(hObject);
CloseHandle(Thread);
```

先去看看 StartAddress

![](https://pic1.imgdb.cn/item/67b56e38d0e0a243d400b094.png)

跟进去看到调用了 sub_41112c

![](https://pic1.imgdb.cn/item/67b56e4ad0e0a243d400b0a0.png)

跟进去发现又是调用

![](https://pic1.imgdb.cn/item/67b574c7d0e0a243d400b3f3.png)

再跟进去就是算法了

![](https://pic1.imgdb.cn/item/67b57e80d0e0a243d400b70e.png)

回头再看第二个线程

![](https://pic1.imgdb.cn/item/67b57618d0e0a243d400b48b.png)

跟进去

![](https://pic1.imgdb.cn/item/67b57606d0e0a243d400b478.png)

查看 dword_41808 的值是 29

![](https://pic1.imgdb.cn/item/67b576fad0e0a243d400b4c2.png)

结合起来看先调用 StartAddress 函数然后 dword_418008 -1

但如图第二个线程中的函数 sub_41119F 不会调用 sub_41112C 这个函数，而是直接把计数值减一

这就意味着输入的 flag 里只有一半的字符会通过 sub_41112C 被变换，其余的一半不会变

去查找 0ff_418000 的值

![](https://pic1.imgdb.cn/item/67b57a65d0e0a243d400b591.png)

最后还调用了函数，跟进去

![](https://pic1.imgdb.cn/item/67b57abfd0e0a243d400b5ae.png)

发现是与 off_418004 做了比较

![](https://pic1.imgdb.cn/item/67b57ae0d0e0a243d400b5b5.png)

去找 off_418004 的值

![](https://pic1.imgdb.cn/item/67b57b3fd0e0a243d400b5c9.png)

编写脚本

```python
off_418000 = "QWERTYUIOPASDFGHJKLZXCVBNMqwertyuiopasdfghjklzxcvbnm"

off_418004 = "TOiZiZtOrYaToUwPnToBsOaOapsyS"

flag=''

for i in range(len(off_418004)):
    if i % 2 == 0:
        flag += off_418004[i]
        continue
        
    for j,k in enumerate(off_418000):
        if off_418004[i] == k:
            if chr(j+38).isupper():
                flag += chr(j+38)
            else:
                flag += chr(j+96)

print(flag)

# flag{ThisisthreadofwindowshahaIsESE}
# 我们需要再得到的字符串后面在加一位，buu 上需要加 E
```

